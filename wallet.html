<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
    body {
        font-family: 'Outfit', sans-serif;
        background-color: #050505; /* Deepest Black */
        color: #ffffff;
    }
    
    /* Modern Gradient Text */
    .text-gradient-gold {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Soft Glow Effects */
    .glow-card {
        background: #111111;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .input-field {
        background: #1A1A1A;
        border: 1px solid #333;
        transition: all 0.3s ease;
    }
    .input-field:focus {
        border-color: #10B981;
        background: #000;
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
    }

    /* Button Animations */
    .btn-action {
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
    }
    .btn-action:active {
        transform: scale(0.97);
    }
    
    /* Custom Scrollbar hide */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { 
      -webkit-appearance: none; margin: 0; 
    }
</style>

<main class="max-w-md mx-auto px-4 py-8 space-y-6 pb-20">

    <section class="relative overflow-hidden rounded-[2rem] p-8 text-center border border-white/10 shadow-2xl bg-[#0a0a0a]">
        <div class="absolute top-0 right-0 w-40 h-40 bg-emerald-600/20 rounded-full blur-[80px] -mr-10 -mt-10"></div>
        <div class="absolute bottom-0 left-0 w-40 h-40 bg-blue-600/10 rounded-full blur-[80px] -ml-10 -mb-10"></div>
        
        <div class="relative z-10">
            <p class="text-gray-400 text-xs font-bold uppercase tracking-[0.3em] mb-2">Total Balance</p>
            <h2 id="walletTotal_page" class="text-white font-black text-6xl flex items-center justify-center gap-3 tracking-tight">
                <img src="https://i.postimg.cc/3R7QM12R/wallet-filled-money-tool.png" class="w-12 h-12 drop-shadow-md grayscale hover:grayscale-0 transition-all"> ₹0
            </h2>
        </div>
    </section>

    <section class="grid grid-cols-2 gap-4">
        <div class="glow-card rounded-2xl p-5 flex flex-col items-center justify-center relative overflow-hidden group">
            <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="w-8 h-8 rounded-full bg-emerald-500/10 flex items-center justify-center mb-2 text-emerald-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
            </div>
            <p class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Deposit</p>
            <h2 id="depositAmount_page" class="text-white font-bold text-2xl tracking-wide">₹0</h2>
        </div>

        <div class="glow-card rounded-2xl p-5 flex flex-col items-center justify-center relative overflow-hidden group">
            <div class="absolute inset-0 bg-yellow-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="w-8 h-8 rounded-full bg-yellow-500/10 flex items-center justify-center mb-2 text-yellow-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
            </div>
            <p class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Winnings</p>
            <h2 id="winningsAmount_page" class="text-gradient-gold font-bold text-2xl tracking-wide">₹0</h2>
        </div>
    </section>

    <section class="glow-card rounded-[2rem] p-1 shadow-lg">
        <div class="bg-[#0f0f0f] rounded-[1.8rem] p-6 space-y-5 border border-white/5">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="w-1 h-6 bg-emerald-500 rounded-full"></span>
                    Add Cash
                </h3>
                <span class="text-xs text-emerald-500/80 font-mono bg-emerald-900/20 px-2 py-1 rounded">SECURE</span>
            </div>

            <div class="relative group">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold group-focus-within:text-emerald-500 transition-colors">₹</div>
                <input id="amountInput" type="number" min="10" placeholder="Enter Amount (Min 10)" 
                    class="input-field w-full pl-8 pr-4 py-4 rounded-xl text-white font-bold text-lg placeholder-gray-600 outline-none">
            </div>

            <button id="addBtn" class="btn-action w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-sm uppercase tracking-widest shadow-[0_10px_20px_-10px_rgba(16,185,129,0.5)]">
                Proceed to Pay
            </button>

            <div id="qrWrap" class="hidden space-y-5 pt-4 border-t border-dashed border-gray-800 animate-fade-in-down">
                <div class="bg-white p-4 rounded-2xl w-48 h-48 mx-auto shadow-inner flex items-center justify-center">
                    <img src="https://i.postimg.cc/T1S1SX3t/1769503340588.png" class="w-full h-full object-contain">
                </div>
                
                <div class="bg-emerald-900/10 p-4 rounded-xl border border-emerald-500/20 text-center">
                    <p class="text-gray-400 text-xs uppercase mb-1">Total Payable</p>
                    <p class="font-black text-white text-2xl">₹<span id="qrAmount">0</span></p>
                </div>

                <div class="space-y-2">
                    <label class="text-xs text-gray-400 ml-2">Upload Payment Screenshot</label>
                    <input type="file" id="proofFile" accept="image/*" 
                        class="w-full bg-[#1A1A1A] border border-dashed border-gray-600 rounded-xl p-3 text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-500/10 file:text-emerald-400 hover:file:bg-emerald-500/20">
                </div>

                <button id="paidBtn" class="btn-action w-full py-4 bg-white text-black rounded-xl font-bold text-sm shadow-lg">
                    CONFIRM PAYMENT
                </button>
            </div>
        </div>
    </section>

    <section class="glow-card rounded-[2rem] p-1 shadow-lg mt-8">
        <div class="bg-[#0f0f0f] rounded-[1.8rem] p-6 space-y-5 border border-white/5">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="w-1 h-6 bg-yellow-500 rounded-full"></span>
                    Withdraw
                </h3>
                <span class="text-xs text-yellow-500/80 font-mono bg-yellow-900/20 px-2 py-1 rounded">FAST</span>
            </div>

            <div class="space-y-3">
                <input id="withdrawAmount" type="number" placeholder="Amount (Min ₹15)" 
                    class="input-field w-full p-4 rounded-xl text-white font-bold text-sm placeholder-gray-600 outline-none focus:!border-yellow-500">
                
                <input id="withdrawUPI" type="text" placeholder="UPI ID (e.g. user@oksbi)" 
                    class="input-field w-full p-4 rounded-xl text-white font-bold text-sm placeholder-gray-600 outline-none focus:!border-yellow-500">
            </div>

            <button id="withdrawBtn" class="btn-action w-full py-4 bg-gradient-to-r from-yellow-600 to-amber-600 hover:from-yellow-500 hover:to-amber-500 text-black rounded-xl font-bold text-sm uppercase tracking-widest shadow-[0_10px_20px_-10px_rgba(245,158,11,0.4)]">
                Withdraw Money
            </button>
        </div>
    </section>

</main>

<script type="module">
    // লজিক শুরু - Logic remains EXACTLY as provided
    import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, runTransaction } 
    from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const db = getFirestore();
    const auth = getAuth();

    function initializeWallet() {
        const user = auth.currentUser;
        if (!user) return;

        // ব্যালেন্স আপডেট
        const userDocRef = doc(db, "users", user.uid);
        onSnapshot(userDocRef, (snap) => {
            if (snap.exists() && document.getElementById('walletTotal_page')) {
                const data = snap.data();
                const dep = Number(data.deposit || 0);
                const win = Number(data.winnings || 0);
                document.getElementById("walletTotal_page").innerHTML = `<img src="https://i.postimg.cc/3R7QM12R/wallet-filled-money-tool.png" class="w-12 h-12 drop-shadow-md grayscale hover:grayscale-0 transition-all"> ₹${dep + win}`;
                document.getElementById("depositAmount_page").textContent = `₹${dep}`;
                document.getElementById("winningsAmount_page").textContent = `₹${win}`;
            }
        });

        // Add Money বাটন ক্লিক লজিক
        const addBtn = document.getElementById("addBtn");
        const qrWrap = document.getElementById("qrWrap");
        if (addBtn) {
            addBtn.onclick = () => {
                const amt = parseInt(document.getElementById("amountInput").value);
                if (amt < 10 || isNaN(amt)) return alert("Minimum ₹10 required");
                document.getElementById("qrAmount").textContent = amt;
                qrWrap.classList.remove("hidden");
                addBtn.classList.add("hidden");
            };
        }

        // পেমেন্ট সাবমিট (Cloudinary + Firestore)
        const paidBtn = document.getElementById("paidBtn");
        if (paidBtn) {
            paidBtn.onclick = async () => {
                const file = document.getElementById("proofFile").files[0];
                const amt = parseInt(document.getElementById("amountInput").value);
                if (!file) return alert("Please upload screenshot");

                paidBtn.disabled = true;
                paidBtn.textContent = "Processing...";

                try {
                    const fd = new FormData();
                    fd.append("file", file);
                    fd.append("upload_preset", "screenshots");

                    const res = await fetch("https://api.cloudinary.com/v1_1/dey1abl9g/image/upload", { 
                        method: "POST", body: fd 
                    });
                    const data = await res.json();

                    if (!data.secure_url) throw new Error("Upload failed");

                    await addDoc(collection(db, "addMoneyRequests"), {
                        uid: user.uid,
                        email: user.email || "",
                        amount: amt,
                        proofUrl: data.secure_url,
                        status: "pending",
                        requestTime: serverTimestamp()
                    });

                    alert("✅ Success! Request submitted.");
                    window.router.navigate('home');
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    paidBtn.disabled = false;
                    paidBtn.textContent = "SUBMIT REQUEST";
                }
            };
        }

        // Withdraw লজিক
        const withdrawBtn = document.getElementById("withdrawBtn");
        if (withdrawBtn) {
            withdrawBtn.onclick = async () => {
                const amt = parseInt(document.getElementById("withdrawAmount").value);
                const upi = document.getElementById("withdrawUPI").value.trim();
                if (amt < 15 || isNaN(amt)) return alert("Min ₹15 withdrawal");
                if (!upi.includes("@")) return alert("Invalid UPI ID");

                withdrawBtn.disabled = true;
                withdrawBtn.textContent = "Sending...";

                try {
                    await runTransaction(db, async (tx) => {
                        const s = await tx.get(userDocRef);
                        const win = Number(s.data().winnings || 0);
                        if (win < amt) throw "Insufficient balance!";
                        tx.update(userDocRef, { winnings: win - amt });
                    });

                    await addDoc(collection(db, "withdrawalRequests"), {
                        uid: user.uid,
                        amount: amt,
                        upi: upi,
                        status: "pending",
                        requestTime: serverTimestamp()
                    });

                    alert("✅ Withdrawal Request Sent!");
                    window.router.navigate('home');
                } catch (e) {
                    alert("Error: " + e);
                } finally {
                    withdrawBtn.disabled = false;
                    withdrawBtn.textContent = "Withdraw Request";
                }
            };
        }
    }

    // SPA-র জন্য নিরাপদ রানার
    setTimeout(initializeWallet, 300);
</script>
