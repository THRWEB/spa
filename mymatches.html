<style>
    .es-card {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border-radius: 1.3rem;
      border: 1px solid rgba(162, 28, 175, 0.2);
      border-left: 6px solid #a21caf;
      width: 100%;
      max-width: 400px;
      margin: 0 auto 1.5rem auto;
      padding: 1rem;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      gap: 1rem;
      align-items: flex-start;
    }

    .es-match-image {
      flex-shrink: 0;
      width: 80px; height: 80px; 
      border-radius: .86rem;
      object-fit: cover;
      border: 2px solid #a21caf;
    }

    .es-title {
      color: #e879f9;
      font-size: 1.1rem;
      font-weight: bold;
      line-height: 1.22;
      margin-bottom: 4px;
    }

    .es-row { font-size: .9rem; color: #d1d5db; display: flex; gap: 0.4em; }
    .es-label { font-weight: 500; color: #9ca3af; min-width: 80px; }
    .es-value { color: #f3f4f6; font-weight: 600; }
    .es-name { color: #34d399; font-weight: 700; }
    .es-room { color: #bef264; font-weight: 800; }
    .es-pass { color: #7dd3fc; font-weight: 700; }

    .es-timer {
      font-size: .8rem; font-weight: 700; color: #facc15;
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.5); padding: 2px 10px; border-radius: 20px;
    }

    @media (max-width: 480px) {
      .es-card { flex-direction: column; }
      .es-match-image { width: 100%; height: 120px; }
    }
</style>

<main class="max-w-xl mx-auto px-4 py-4">
    <h2 class="text-xl font-bold text-center mb-6 text-purple-200 uppercase tracking-wider">Joined Matches</h2>
    <div id="matchesList"></div>
    <div id="noMatches" class="text-center text-gray-400 mt-20 hidden">
      You have not joined any matches yet.
    </div>
</main>

<script>
    (async function() {
        const matchesList = document.getElementById('matchesList');
        const noMatches = document.getElementById('noMatches');
        const TIMER_MINUTES = 30;

        // কার্ড তৈরি করার ফাংশন
        function createMatchCard(match, joinedName) {
            const div = document.createElement('div');
            div.className = "es-card shadow-lg shadow-purple-900/10";

            // রুম আইডি টাইমার লজিক
            if (match.roomgivenat && typeof match.roomgivenat === "object") {
                const expiryTime = (match.roomgivenat.seconds * 1000) + (TIMER_MINUTES * 60 * 1000);
                const timerDiv = document.createElement('div');
                timerDiv.className = "es-timer";
                div.appendChild(timerDiv);

                const timerId = setInterval(() => {
                    const remaining = expiryTime - Date.now();
                    if (remaining > 0) {
                        const mins = Math.floor(remaining / 60000);
                        const secs = Math.floor((remaining % 60000) / 1000);
                        timerDiv.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        div.remove();
                        clearInterval(timerId);
                    }
                }, 1000);
            }

            const matchDisplayTime = window.formatMatchTime ? window.formatMatchTime(match.time) : 'TBA';

            div.innerHTML += `
                <img class="es-match-image" src="${match.image || 'https://i.postimg.cc/rsf7yB1M/1768308154801.jpg'}">
                <div class="es-match-info">
                  <div class="es-title">${match.title || 'Classic Match'}</div>
                  <div class="es-row"><span class="es-label">Joined As:</span> <span class="es-name">${joinedName}</span></div>
                  <div class="es-row"><span class="es-label">Entry Fee:</span> <span class="es-value">₹${match.entry || '0'}</span></div>
                  <div class="es-row"><span class="es-label">Prize:</span> <span class="es-value">₹${match.prize || '0'}</span></div>
                  <div class="es-row"><span class="es-label">Match Time:</span> <span class="es-value text-xs">${matchDisplayTime}</span></div>
                  <div class="es-row mt-2"><span class="es-label">Room ID:</span> <span class="es-room">${match.roomid || 'WAIT'}</span></div>
                  <div class="es-row"><span class="es-label">Room Pass:</span> <span class="es-pass">${match.roompass || 'WAIT'}</span></div>
                </div>
            `;
            return div;
        }

        // ম্যাচ ডেটা ফেচ করা (Firebase instance use করা হচ্ছে যা index.html থেকে আসছে)
        const user = firebase.auth().currentUser;
        if (user) {
            const db = firebase.firestore();
            try {
                const snapshot = await db.collection("allMatches").get();
                const userMatches = [];
                
                snapshot.docs.forEach(mDoc => {
                    const match = mDoc.data();
                    const joinedPlayers = match.joinedPlayers || [];
                    const myJoins = joinedPlayers.filter(jp => jp.uid === user.uid);
                    myJoins.forEach(jp => userMatches.push({ match, joinedName: jp.name }));
                });

                if (userMatches.length === 0) {
                    noMatches.classList.remove('hidden');
                } else {
                    matchesList.innerHTML = '';
                    userMatches.reverse().forEach(({match, joinedName}) => {
                        matchesList.appendChild(createMatchCard(match, joinedName));
                    });
                }
            } catch (err) {
                console.error("Error loading matches:", err);
            }
        }
    })();
</script>
