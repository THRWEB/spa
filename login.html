<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>FFTW - Login</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url('https://i.postimg.cc/kDPBb1rP/file-00000000f6b8622f83cf3191487cb4e0-2.png') center/cover no-repeat fixed;
      margin: 0; color: white;
    }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 0; }
    .loading-spinner { stroke: #10b981; animation: spin 1s linear infinite; height: 32px; width: 32px; margin: 1rem auto 0; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="relative flex items-center justify-center min-h-screen px-4">
  <div class="overlay"></div>
  <main class="relative z-10 max-w-md w-full bg-emerald-950/90 backdrop-blur-sm rounded-2xl p-8 shadow-[0_0_25px_rgba(16,185,129,0.5)] border border-emerald-500/30">
    <h1 id="formTitle" class="text-center text-2xl font-bold mb-6 text-emerald-400">Login to FFTW</h1>
    <form id="authForm" class="space-y-5" novalidate>
      <div>
        <label class="block text-emerald-200 font-semibold mb-1 text-sm">Email Address</label>
        <input id="emailInput" type="email" placeholder="Enter your email" required class="w-full px-4 py-3 rounded-lg bg-emerald-900/50 text-white border border-emerald-500/30 outline-none" />
      </div>
      <div id="passwordGroup">
        <label class="block text-emerald-200 font-semibold mb-1 text-sm">Password</label>
        <input id="passwordInput" type="password" placeholder="Enter your password" required class="w-full px-4 py-3 rounded-lg bg-emerald-900/50 text-white border border-emerald-500/30 outline-none" />
      </div>
      <div id="referralGroup" style="display: none;">
        <label class="block text-emerald-200 font-semibold mb-1 text-sm">Referral Code (Optional)</label>
        <input id="referralInput" type="text" placeholder="Enter refer code" class="w-full px-4 py-3 rounded-lg bg-emerald-900/50 text-white border border-emerald-500/30 outline-none" />
      </div>
      <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 font-bold text-white rounded-lg py-3 shadow-lg active:scale-95 transition-all">Login</button>
    </form>
    <button id="forgotPasswordBtn" class="mt-4 w-full text-emerald-400 underline text-sm">Forgot Password?</button>
    <p id="toggleAuthLink" class="mt-6 text-center text-emerald-400 cursor-pointer font-semibold">New user? Sign up here</p>
    <p id="msg" class="mt-4 text-center font-semibold text-sm min-h-[20px]"></p>
    <svg class="loading-spinner mx-auto" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke-width="5" /></svg>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1vzDj_3-tymzU-EomjCIlbMhsoSnDiTU",
      authDomain: "ffth01.firebaseapp.com",
      projectId: "ffth01",
      storageBucket: "ffth01.firebasestorage.app",
      messagingSenderId: "879174774047",
      appId: "1:879174774047:web:386e99dd5c947381c4142a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authForm = document.getElementById('authForm');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const referralInput = document.getElementById('referralInput');
    const referralGroup = document.getElementById('referralGroup');
    const submitBtn = document.getElementById('submitBtn');
    const toggleAuthLink = document.getElementById('toggleAuthLink');
    const msg = document.getElementById('msg');
    const spinner = document.querySelector('.loading-spinner');

    let mode = 'login';

    toggleAuthLink.onclick = () => {
      mode = (mode === 'login') ? 'signup' : 'login';
      document.getElementById('formTitle').textContent = (mode === 'signup') ? 'Create Account' : 'Login to FFTW';
      submitBtn.textContent = (mode === 'signup') ? 'Sign Up' : 'Login';
      referralGroup.style.display = (mode === 'signup') ? 'block' : 'none';
      toggleAuthLink.textContent = (mode === 'signup') ? 'Already have an account? Login' : 'New user? Sign up here';
    };

    authForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = ""; spinner.style.display = "block";
      
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const referEntered = referralInput.value.trim().toUpperCase();

      try {
        if (mode === 'login') {
          await signInWithEmailAndPassword(auth, email, password);
          window.location.href = 'index.html';
        } else {
          // ১. রেফার কোড চেক
          let referrerUID = null;
          if (referEntered) {
            const q = query(collection(db, "users"), where("referCode", "==", referEntered));
            const snap = await getDocs(q);
            if (!snap.empty) {
              referrerUID = snap.docs[0].id;
            } else {
                throw new Error("Invalid Referral Code!");
            }
          }

          // ২. ইউজার তৈরি
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCred.user;

          // ৩. ইউনিক রেফার কোড জেনারেট
          const myRefer = email.split('@')[0].substring(0, 3).toUpperCase() + Math.floor(100 + Math.random() * 900);

          // ৪. Firestore-এ ডাটা সেভ
          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            email: user.email,
            username: email.split('@')[0],
            referCode: myRefer,
            referredBy: referrerUID,
            deposit: 0,
            winnings: 0,
            playedMatches: 0,
            profilePic: "https://cdn-icons-png.flaticon.com/512/1144/1144760.png",
            createdAt: serverTimestamp()
          });

          window.location.href = 'index.html';
        }
      } catch (err) {
        msg.textContent = err.message;
        msg.style.color = "red";
      }
      spinner.style.display = "none";
    };
  </script>
</body>
</html>
